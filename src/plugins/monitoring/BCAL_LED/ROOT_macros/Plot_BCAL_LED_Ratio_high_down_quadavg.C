#include <unistd.h>
using namespace std;


void split(const std::string &s, char delim, std::vector<std::string> &elems) {
    std::stringstream ss;
    ss.str(s);
    std::string item;
    while (std::getline(ss, item, delim)) {
        elems.push_back(item);
    }
}

TFile *GetReferenceFile(Int_t run, TString variation = "default"){
    char command[1024];
    // first get the location of the file
    sprintf(command, "ccdb dump %s:%i:%s", "/BCAL/LED_monitoring/reference_file", run, variation.Data());
    FILE* inputPipe = gSystem->OpenPipe(command, "r");
    if(inputPipe == NULL)
        return NULL;
    //get the first (comment) line
    char buff[1024];
    if(fgets(buff, sizeof(buff), inputPipe) == NULL)
        return NULL;
    //get the actual data
    if(fgets(buff, sizeof(buff), inputPipe) == NULL)
        return NULL;
    stringstream ss;
    ss << buff;
    char url_base[1024], path_name[1024];
    ss >> url_base >> path_name;
    //Close the pipe
    gSystem->ClosePipe(inputPipe);

    // build URL of the location of the file
    stringstream ss_url;
    //cout << url_base << endl;
    //cout << table_name << endl;
	ss_url << url_base << "/" << path_name;
	
	// figure out the name of the file
	vector<string> tokens;
	split(path_name, '/', tokens);
	string filename = *(tokens.end()-1);
	
	// download the file if it doesn't already exist
	ifstream f(filename.c_str());
	if(!f.good()) {
		sprintf(command, "curl -O %s", ss_url.str().c_str());
		gSystem->Exec(command);
	} else {
		f.close();
	}


	// open it and return
	TFile *rootfile = new TFile(filename.c_str());
	
	// error check
	
	return rootfile;
}

void Plot_BCAL_LED_Ratio_high_down_quadavg(string infilename = "hd_root.root", int run = 20000)
{
  // #include <TRandom.h>

  //gROOT->Reset();
gStyle->SetPalette(1,0);
gStyle->SetOptStat(kFALSE);
// gStyle->SetOptStat(11111111);
gStyle->SetPadRightMargin(0.15);
gStyle->SetPadLeftMargin(0.15);
gStyle->SetPadBottomMargin(0.15);
//

   char string[256];
   //char path[256];
   Int_t j,k;
   Int_t n;
   Int_t errorbars = 0;
    
    TProfile *run1_high_down_1 = NULL;
    TProfile *run1_high_down_2 = NULL;
    TProfile *run1_high_down_3 = NULL;
    TProfile *run1_high_down_4 = NULL;

    TProfile *run2_high_down_1 = NULL;
    TProfile *run2_high_down_2 = NULL;
    TProfile *run2_high_down_3 = NULL;
    TProfile *run2_high_down_4 = NULL;

    TH1D *run1_high_down_1_hist = NULL;
    TH1D *run1_high_down_2_hist = NULL;
    TH1D *run1_high_down_3_hist = NULL;
    TH1D *run1_high_down_4_hist = NULL;

    TH1D *run2_high_down_1_hist = NULL;
    TH1D *run2_high_down_2_hist = NULL;
    TH1D *run2_high_down_3_hist = NULL;
    TH1D *run2_high_down_4_hist = NULL;
    
   
//   sprintf(string,"hd_root.root");
//   sprintf(string,"0%03i/bcalled0%03i.root",runnumber1,runnumber1);
   printf ("Histogram input filename=%s\n",infilename.c_str());
   TFile *run1in = new TFile(infilename.c_str(),"read");
	
// 		TProfile *sector1_up_peak_vevent4 = (TProfile*)run1in->Get("bcalLED/sector1_up_peak_vevent4");
// 		if (sector1_up_peak_vevent4->FindLastBinAbove(0,1) > 100) 
		run1_high_down_1 = (TProfile*)run1in->Get("bcalLED/high_bias_down_sector_1_peak_vchannel");

// 		TProfile *sector2_up_peak_vevent4 = (TProfile*)run1in->Get("bcalLED/sector2_up_peak_vevent4");
//  		if (sector2_up_peak_vevent4->FindLastBinAbove(0,1) > 100) 
		run1_high_down_2 = (TProfile*)run1in->Get("bcalLED/high_bias_down_sector_2_peak_vchannel");

// 		TProfile *sector3_up_peak_vevent4 = (TProfile*)run1in->Get("bcalLED/sector3_up_peak_vevent4");
//  		if (sector3_up_peak_vevent4->FindLastBinAbove(0,1) > 100) 
		run1_high_down_3 = (TProfile*)run1in->Get("bcalLED/high_bias_down_sector_3_peak_vchannel");

// 		TProfile *sector4_up_peak_vevent4 = (TProfile*)run1in->Get("bcalLED/sector4_up_peak_vevent4");
//  		if (sector4_up_peak_vevent4->FindLastBinAbove(0,1) > 100) 
		run1_high_down_4 = (TProfile*)run1in->Get("bcalLED/high_bias_down_sector_4_peak_vchannel");
		
		//sprintf(string,"BCAL_LED_Reference_Spring2016.root");
		//printf ("Histogram input filename=%s\n",string);
		//TFile *run2in = new TFile(string,"read");
		TFile *run2in = GetReferenceFile(run);
		
		run2_high_down_1 = (TProfile*)run2in->Get("bcalLED/high_bias_down_sector_1_peak_vchannel");
		run2_high_down_2 = (TProfile*)run2in->Get("bcalLED/high_bias_down_sector_2_peak_vchannel");
		run2_high_down_3 = (TProfile*)run2in->Get("bcalLED/high_bias_down_sector_3_peak_vchannel");
		run2_high_down_4 = (TProfile*)run2in->Get("bcalLED/high_bias_down_sector_4_peak_vchannel");
		
		cout << "input profiles, projecting into histograms" << "\n";
		
		 run1_high_down_1_hist = run1_high_down_1->ProjectionX("run1_high_down_1_projectionx");
		 run1_high_down_2_hist = run1_high_down_2->ProjectionX("run1_high_down_2_projectionx");
		 run1_high_down_3_hist = run1_high_down_3->ProjectionX("run1_high_down_3_projectionx");
		 run1_high_down_4_hist = run1_high_down_4->ProjectionX("run1_high_down_4_projectionx");
		
		 run2_high_down_1_hist = run2_high_down_1->ProjectionX("run2_high_down_1_projectionx");
		 run2_high_down_2_hist = run2_high_down_2->ProjectionX("run2_high_down_2_projectionx");
		 run2_high_down_3_hist = run2_high_down_3->ProjectionX("run2_high_down_3_projectionx");
		 run2_high_down_4_hist = run2_high_down_4->ProjectionX("run2_high_down_4_projectionx");

		
		cout << "profiles projected into histograms" << "\n";

		run1_high_down_1_hist->SetTitle("6.25v Downstream sector 1");
		run1_high_down_2_hist->SetTitle("6.25v Downstream sector 2");
		run1_high_down_3_hist->SetTitle("6.25v Downstream sector 3");
		run1_high_down_4_hist->SetTitle("6.25v Downstream sector 4");
		
		cout << "Dividing over quadrant average" << "\n";
		
		cout << "Dividing over quadrant average" << "\n";
		
		double  quad1sector1avgrun1 = run1_high_down_1_hist->Integral(0,191);
		double  quad2sector1avgrun1 = run1_high_down_1_hist->Integral(192,383);
		double  quad3sector1avgrun1 = run1_high_down_1_hist->Integral(384,575);
		double  quad4sector1avgrun1 = run1_high_down_1_hist->Integral(576,767);
		double  quad5sector1avgrun1 = run1_high_down_1_hist->Integral(768,959);
		double  quad6sector1avgrun1 = run1_high_down_1_hist->Integral(960,1151);
		double  quad7sector1avgrun1 = run1_high_down_1_hist->Integral(1152,1343);
		double  quad8sector1avgrun1 = run1_high_down_1_hist->Integral(1344,1535);

		double  quad1sector2avgrun1 = run1_high_down_2_hist->Integral(0,191);
		double  quad2sector2avgrun1 = run1_high_down_2_hist->Integral(192,383);
		double  quad3sector2avgrun1 = run1_high_down_2_hist->Integral(384,575);
		double  quad4sector2avgrun1 = run1_high_down_2_hist->Integral(576,767);
		double  quad5sector2avgrun1 = run1_high_down_2_hist->Integral(768,959);
		double  quad6sector2avgrun1 = run1_high_down_2_hist->Integral(960,1151);
		double  quad7sector2avgrun1 = run1_high_down_2_hist->Integral(1152,1343);
		double  quad8sector2avgrun1 = run1_high_down_2_hist->Integral(1344,1535);

		double  quad1sector3avgrun1 = run1_high_down_3_hist->Integral(0,191);
		double  quad2sector3avgrun1 = run1_high_down_3_hist->Integral(192,383);
		double  quad3sector3avgrun1 = run1_high_down_3_hist->Integral(384,575);
		double  quad4sector3avgrun1 = run1_high_down_3_hist->Integral(576,767);
		double  quad5sector3avgrun1 = run1_high_down_3_hist->Integral(768,959);
		double  quad6sector3avgrun1 = run1_high_down_3_hist->Integral(960,1151);
		double  quad7sector3avgrun1 = run1_high_down_3_hist->Integral(1152,1343);
		double  quad8sector3avgrun1 = run1_high_down_3_hist->Integral(1344,1535);

		double  quad1sector4avgrun1 = run1_high_down_4_hist->Integral(0,191);
		double  quad2sector4avgrun1 = run1_high_down_4_hist->Integral(192,383);
		double  quad3sector4avgrun1 = run1_high_down_4_hist->Integral(384,575);
		double  quad4sector4avgrun1 = run1_high_down_4_hist->Integral(576,767);
		double  quad5sector4avgrun1 = run1_high_down_4_hist->Integral(768,959);
		double  quad6sector4avgrun1 = run1_high_down_4_hist->Integral(960,1151);
		double  quad7sector4avgrun1 = run1_high_down_4_hist->Integral(1152,1343);
		double  quad8sector4avgrun1 = run1_high_down_4_hist->Integral(1344,1535);
		
		double  quad1avgrun1 = quad1sector1avgrun1 + quad1sector2avgrun1 + quad1sector3avgrun1 + quad1sector4avgrun1;
		double  quad2avgrun1 = quad2sector1avgrun1 + quad2sector2avgrun1 + quad2sector3avgrun1 + quad2sector4avgrun1;
		double  quad3avgrun1 = quad3sector1avgrun1 + quad3sector2avgrun1 + quad3sector3avgrun1 + quad3sector4avgrun1;
		double  quad4avgrun1 = quad4sector1avgrun1 + quad4sector2avgrun1 + quad4sector3avgrun1 + quad4sector4avgrun1;
		double  quad5avgrun1 = quad5sector1avgrun1 + quad5sector2avgrun1 + quad5sector3avgrun1 + quad5sector4avgrun1;
		double  quad6avgrun1 = quad6sector1avgrun1 + quad6sector2avgrun1 + quad6sector3avgrun1 + quad6sector4avgrun1;
		double  quad7avgrun1 = quad7sector1avgrun1 + quad7sector2avgrun1 + quad7sector3avgrun1 + quad7sector4avgrun1;
		double  quad8avgrun1 = quad8sector1avgrun1 + quad8sector2avgrun1 + quad8sector3avgrun1 + quad8sector4avgrun1;

		double quadav, bincontent1, bincontent2, bincontent3, bincontent4;
		
		for (int chid=0; chid < 1536 ; chid++)
		{
		quadav=0;
		bincontent1=0;
		bincontent2=0;
		bincontent3=0;
		bincontent4=0;
		if (chid < 192 && chid > -1) {quadav = quad1avgrun1;}
		if (chid < 384 && chid > 191) {quadav = quad2avgrun1;}
		if (chid < 576 && chid > 383) {quadav = quad3avgrun1;}
		if (chid < 768 && chid > 575) {quadav = quad4avgrun1;}
		if (chid < 960 && chid > 767) {quadav = quad5avgrun1;}
		if (chid < 1152 && chid > 959) {quadav = quad6avgrun1;}
		if (chid < 1344 && chid > 1151) {quadav = quad7avgrun1;}
		if (chid < 1536 && chid > 1343) {quadav = quad8avgrun1;}
		bincontent1 = run1_high_down_1_hist->GetBinContent(chid);
		bincontent2 = run1_high_down_2_hist->GetBinContent(chid);
		bincontent3 = run1_high_down_3_hist->GetBinContent(chid);
		bincontent4 = run1_high_down_4_hist->GetBinContent(chid);
		run1_high_down_1_hist->SetBinContent(chid, bincontent1/quadav);
		run1_high_down_2_hist->SetBinContent(chid, bincontent2/quadav);
		run1_high_down_3_hist->SetBinContent(chid, bincontent3/quadav);
		run1_high_down_4_hist->SetBinContent(chid, bincontent4/quadav);
		}

		double  quad1sector1avgrun2 = run2_high_down_1_hist->Integral(0,191);
		double  quad2sector1avgrun2 = run2_high_down_1_hist->Integral(192,383);
		double  quad3sector1avgrun2 = run2_high_down_1_hist->Integral(384,575);
		double  quad4sector1avgrun2 = run2_high_down_1_hist->Integral(576,767);
		double  quad5sector1avgrun2 = run2_high_down_1_hist->Integral(768,959);
		double  quad6sector1avgrun2 = run2_high_down_1_hist->Integral(960,1151);
		double  quad7sector1avgrun2 = run2_high_down_1_hist->Integral(1152,1343);
		double  quad8sector1avgrun2 = run2_high_down_1_hist->Integral(1344,1535);

		double  quad1sector2avgrun2 = run2_high_down_2_hist->Integral(0,191);
		double  quad2sector2avgrun2 = run2_high_down_2_hist->Integral(192,383);
		double  quad3sector2avgrun2 = run2_high_down_2_hist->Integral(384,575);
		double  quad4sector2avgrun2 = run2_high_down_2_hist->Integral(576,767);
		double  quad5sector2avgrun2 = run2_high_down_2_hist->Integral(768,959);
		double  quad6sector2avgrun2 = run2_high_down_2_hist->Integral(960,1151);
		double  quad7sector2avgrun2 = run2_high_down_2_hist->Integral(1152,1343);
		double  quad8sector2avgrun2 = run2_high_down_2_hist->Integral(1344,1535);

		double  quad1sector3avgrun2 = run2_high_down_3_hist->Integral(0,191);
		double  quad2sector3avgrun2 = run2_high_down_3_hist->Integral(192,383);
		double  quad3sector3avgrun2 = run2_high_down_3_hist->Integral(384,575);
		double  quad4sector3avgrun2 = run2_high_down_3_hist->Integral(576,767);
		double  quad5sector3avgrun2 = run2_high_down_3_hist->Integral(768,959);
		double  quad6sector3avgrun2 = run2_high_down_3_hist->Integral(960,1151);
		double  quad7sector3avgrun2 = run2_high_down_3_hist->Integral(1152,1343);
		double  quad8sector3avgrun2 = run2_high_down_3_hist->Integral(1344,1535);

		double  quad1sector4avgrun2 = run2_high_down_4_hist->Integral(0,191);
		double  quad2sector4avgrun2 = run2_high_down_4_hist->Integral(192,383);
		double  quad3sector4avgrun2 = run2_high_down_4_hist->Integral(384,575);
		double  quad4sector4avgrun2 = run2_high_down_4_hist->Integral(576,767);
		double  quad5sector4avgrun2 = run2_high_down_4_hist->Integral(768,959);
		double  quad6sector4avgrun2 = run2_high_down_4_hist->Integral(960,1151);
		double  quad7sector4avgrun2 = run2_high_down_4_hist->Integral(1152,1343);
		double  quad8sector4avgrun2 = run2_high_down_4_hist->Integral(1344,1535);
		
		double  quad1avgrun2 = quad1sector1avgrun2 + quad1sector2avgrun2 + quad1sector3avgrun2 + quad1sector4avgrun2;
		double  quad2avgrun2 = quad2sector1avgrun2 + quad2sector2avgrun2 + quad2sector3avgrun2 + quad2sector4avgrun2;
		double  quad3avgrun2 = quad3sector1avgrun2 + quad3sector2avgrun2 + quad3sector3avgrun2 + quad3sector4avgrun2;
		double  quad4avgrun2 = quad4sector1avgrun2 + quad4sector2avgrun2 + quad4sector3avgrun2 + quad4sector4avgrun2;
		double  quad5avgrun2 = quad5sector1avgrun2 + quad5sector2avgrun2 + quad5sector3avgrun2 + quad5sector4avgrun2;
		double  quad6avgrun2 = quad6sector1avgrun2 + quad6sector2avgrun2 + quad6sector3avgrun2 + quad6sector4avgrun2;
		double  quad7avgrun2 = quad7sector1avgrun2 + quad7sector2avgrun2 + quad7sector3avgrun2 + quad7sector4avgrun2;
		double  quad8avgrun2 = quad8sector1avgrun2 + quad8sector2avgrun2 + quad8sector3avgrun2 + quad8sector4avgrun2;
		
		for (int chid=0; chid < 1536 ; chid++)
		{
		quadav=0;
		bincontent1=0;
		bincontent2=0;
		bincontent3=0;
		bincontent4=0;
		if (chid < 192 && chid > -1) {quadav = quad1avgrun2;}
		if (chid < 384 && chid > 191) {quadav = quad2avgrun2;}
		if (chid < 576 && chid > 383) {quadav = quad3avgrun2;}
		if (chid < 768 && chid > 575) {quadav = quad4avgrun2;}
		if (chid < 960 && chid > 767) {quadav = quad5avgrun2;}
		if (chid < 1152 && chid > 959) {quadav = quad6avgrun2;}
		if (chid < 1344 && chid > 1151) {quadav = quad7avgrun2;}
		if (chid < 1536 && chid > 1343) {quadav = quad8avgrun2;}
		bincontent1 = run2_high_down_1_hist->GetBinContent(chid);
		bincontent2 = run2_high_down_2_hist->GetBinContent(chid);
		bincontent3 = run2_high_down_3_hist->GetBinContent(chid);
		bincontent4 = run2_high_down_4_hist->GetBinContent(chid);
		run2_high_down_1_hist->SetBinContent(chid, bincontent1/quadav);
		run2_high_down_2_hist->SetBinContent(chid, bincontent2/quadav);
		run2_high_down_3_hist->SetBinContent(chid, bincontent3/quadav);
		run2_high_down_4_hist->SetBinContent(chid, bincontent4/quadav);
		}


		cout << "Dividing histograms" << "\n";
		
		run1_high_down_1_hist->Divide(run2_high_down_1_hist);
		run1_high_down_2_hist->Divide(run2_high_down_2_hist);
		run1_high_down_3_hist->Divide(run2_high_down_3_hist);
		run1_high_down_4_hist->Divide(run2_high_down_4_hist);
		
		cout << "Histograms divided" << "\n";

		run1_high_down_1_hist->SetMinimum(0.8);
		run1_high_down_1_hist->SetMaximum(1.2);
		run1_high_down_2_hist->SetMinimum(0.8);
		run1_high_down_2_hist->SetMaximum(1.2);
		run1_high_down_3_hist->SetMinimum(0.8);
		run1_high_down_3_hist->SetMaximum(1.2);
		run1_high_down_4_hist->SetMinimum(0.8);
		run1_high_down_4_hist->SetMaximum(1.2);

// 	run1_high_down_1_hist->SetMaximum(run1_high_down_1_hist->GetBinContent(run1_high_down_1_hist->GetMaximumBin())*1.05);
//  	run1_high_down_1_hist->SetMinimum(run1_high_down_1_hist->GetMinimum(0.1)*0.95);
//  
//  	run1_high_down_2_hist->SetMaximum(run1_high_down_2_hist->GetBinContent(run1_high_down_2_hist->GetMaximumBin())*1.05);
//  	run1_high_down_2_hist->SetMinimum(run1_high_down_2_hist->GetMinimum(0.1)*0.95);
//  
//  	run1_high_down_3_hist->SetMaximum(run1_high_down_3_hist->GetBinContent(run1_high_down_3_hist->GetMaximumBin())*1.01);
//  	run1_high_down_3_hist->SetMinimum(run1_high_down_3_hist->GetMinimum(0.1)*0.95);
//  
//  	run1_high_down_4_hist->SetMaximum(run1_high_down_4_hist->GetBinContent(run1_high_down_4_hist->GetMaximumBin())*1.01);
//  	run1_high_down_4_hist->SetMinimum(run1_high_down_4_hist->GetMinimum(0.1)*0.95);
				
    
///////////////////////////////////////////////////////////////////////////
   TCanvas *c4 = new TCanvas("c4","c4 pedsubpeak ",200,10,1200,1200);
   c4->Divide(2,2);

   TVirtualPad *c4_1 = c4->cd(1);
   c4_1->SetBorderMode(0);
   c4_1->SetFillColor(0);

   c4_1->SetGridx();
   c4_1->SetGridy();
   c4_1->SetBorderMode(0);
   c4_1->SetFillColor(0);
   
    
   
    if (errorbars ==0) {run1_high_down_1_hist->Draw("hist p");}
    else {run1_high_down_1_hist->Draw("E1 X0");}
    run1_high_down_1_hist->SetMarkerColor(2);    
    run1_high_down_1_hist->SetMarkerStyle(2);

    sprintf(string,"Run ratio to reference");
//    sprintf(string,"Run %05d ratio to reference",runnumber1);
   TLatex *t1 = new TLatex(0.15,0.92,string);
   t1->SetNDC();
   t1->SetTextSize(0.03);
   t1->Draw(); 

    
///////////////////////////////////////////////////////////////////////////
   TVirtualPad *c4_2 = c4->cd(2);
   c4_2->SetBorderMode(0);
   c4_2->SetFillColor(0);

   c4_2->SetGridx();
   c4_2->SetGridy();
   c4_2->SetBorderMode(0);
   c4_2->SetFillColor(0);
   
    
   
    if (errorbars ==0) {run1_high_down_2_hist->Draw("hist p");}
    else {run1_high_down_2_hist->Draw("E1 X0");}
    run1_high_down_2_hist->SetMarkerColor(2);    
    run1_high_down_2_hist->SetMarkerStyle(2);
    
///////////////////////////////////////////////////////////////////////////
   TVirtualPad *c4_3 = c4->cd(3);
   c4_3->SetBorderMode(0);
   c4_3->SetFillColor(0);

   c4_3->SetGridx();
   c4_3->SetGridy();
   c4_3->SetBorderMode(0);
   c4_3->SetFillColor(0);
   
    
   
    if (errorbars ==0) {run1_high_down_3_hist->Draw("hist p");}
    else {run1_high_down_3_hist->Draw("E1 X0");}
    run1_high_down_3_hist->SetMarkerColor(2);    
    run1_high_down_3_hist->SetMarkerStyle(2);

///////////////////////////////////////////////////////////////////////////
   TVirtualPad *c4_4 = c4->cd(4);
   c4_4->SetBorderMode(0);
   c4_4->SetFillColor(0);


   c4_4->SetGridx();
   c4_4->SetGridy();
   c4_4->SetBorderMode(0);
   c4_4->SetFillColor(0);
   
    
   
    if (errorbars ==0) {run1_high_down_4_hist->Draw("hist p");}
    else {run1_high_down_4_hist->Draw("E1 X0");}
    run1_high_down_4_hist->SetMarkerColor(2);    
    run1_high_down_4_hist->SetMarkerStyle(2);

    
 ///////////////////////////////////////////////////////////////////////////////////////////
    
    
    
//     sprintf(string,"bcalled_highdown.pdf");
//     sprintf(string,"bcalled_%05d_highdown.pdf",runnumber1);
//     c4->SaveAs(string);    
    
//gApplication->Terminate();
}

